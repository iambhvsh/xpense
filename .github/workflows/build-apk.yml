name: ğŸš€ Build Xpense Android

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  build:
    name: ğŸ“¦ Build Android Release APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT & SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¦ INSTALL DEPENDENCIES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ—ï¸ BUILD WEB ASSETS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ—ï¸ Build web assets
        run: |
          echo "ğŸ—ï¸ Building production assets with Vite..."
          npm run build
          echo ""
          echo "ğŸ“Š Build Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total size: $(du -sh dist | cut -f1)"
          echo "Total files: $(find dist -type f | wc -l)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Build completed successfully"
        env:
          NODE_ENV: production

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“± SETUP CAPACITOR ANDROID
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“± Setup Android platform
        run: |
          echo "ğŸ“± Setting up Capacitor Android platform..."
          if [ -d "android" ]; then
            echo "ğŸ—‘ï¸ Cleaning existing Android platform..."
            rm -rf android
          fi
          echo "â• Adding Android platform..."
          npx cap add android
          echo "âœ… Android platform added"

      - name: ğŸ¨ Generate app icons
        run: |
          echo "ğŸ¨ Generating app icons and splash screens..."
          npx capacitor-assets generate --android || echo "âš ï¸ Icon generation skipped (optional)"
          echo "âœ… Assets generation complete"

      - name: ğŸ”„ Sync Capacitor
        run: |
          echo "ğŸ”„ Syncing web assets to Android..."
          npx cap sync android
          echo "âœ… Capacitor sync completed"

      - name: ğŸ” Configure Android permissions
        run: |
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          echo "ğŸ” Adding Android permissions to manifest..."
          
          if ! grep -q "READ_MEDIA_IMAGES" "$MANIFEST_PATH"; then
            sed -i '/<\/manifest>/i \    <!-- Camera & Storage Permissions -->\n    <uses-permission android:name="android.permission.CAMERA" />\n    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />\n    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" />' "$MANIFEST_PATH"
            echo "âœ… Permissions added successfully"
          else
            echo "âœ… Permissions already exist"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” KEYSTORE SETUP (SECURE)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Setup signing keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          KEYSTORE_PATH="android/app/release.keystore"
          echo "ğŸ” Setting up release keystore..."
          
          # Check if all required secrets are present
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ ERROR: KEYSTORE_BASE64 secret is not set!"
            echo "ğŸ“ Please add the following secrets to your GitHub repository:"
            echo "   - KEYSTORE_BASE64: Your keystore file encoded in base64"
            echo "   - KEYSTORE_PASSWORD: Your keystore password"
            echo "   - KEY_ALIAS: Your key alias"
            echo "   - KEY_PASSWORD: Your key password"
            echo ""
            echo "ğŸ“ To generate keystore:"
            echo "   keytool -genkey -v -keystore release.keystore -alias xpense \\"
            echo "           -keyalg RSA -keysize 4096 -validity 10000"
            echo ""
            echo "ğŸ“ To encode keystore to base64:"
            echo "   base64 release.keystore | tr -d '\\n'"
            exit 1
          fi
          
          # Decode and save keystore
          echo "$KEYSTORE_BASE64" | base64 -d > "$KEYSTORE_PATH"
          
          if [ ! -f "$KEYSTORE_PATH" ]; then
            echo "âŒ Failed to decode keystore"
            exit 1
          fi
          
          echo "âœ… Keystore configured successfully"
          ls -lh "$KEYSTORE_PATH"

      - name: ï¿½ C onfigure Gradle signing
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          BUILD_GRADLE="android/app/build.gradle"
          echo "ğŸ“ Configuring release signing in build.gradle..."
          
          # Check if signing config already exists
          if grep -q "signingConfigs {" "$BUILD_GRADLE"; then
            echo "âœ… Signing configuration already exists"
          else
            echo "â• Adding signing configuration..."
            # Append signing configuration
            cat >> "$BUILD_GRADLE" << 'EOF'
          
          android {
              signingConfigs {
                  release {
                      storeFile file('release.keystore')
                      storePassword System.getenv('SIGNING_STORE_PASSWORD')
                      keyAlias System.getenv('SIGNING_KEY_ALIAS')
                      keyPassword System.getenv('SIGNING_KEY_PASSWORD')
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }
          EOF
            echo "âœ… Signing configuration added"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ—ï¸ BUILD RELEASE APK
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Setup Gradle
        run: |
          echo "ğŸ”§ Configuring Gradle wrapper..."
          chmod +x android/gradlew
          echo "âœ… Gradle ready"

      - name: ğŸ—ï¸ Build signed release APK
        working-directory: android
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "ğŸ—ï¸ Building signed release APK..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            -Porg.gradle.parallel=true \
            -Porg.gradle.caching=true
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… APK build completed successfully"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… VERIFY & PACKAGE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Verify APK signature
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          echo "âœ… Verifying APK..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at: $APK_PATH"
            echo ""
            echo "ğŸ” Searching for APK files..."
            find android/app/build/outputs -name "*.apk" -type f || true
            exit 1
          fi
          
          echo "âœ… APK found successfully!"
          echo ""
          echo "ğŸ“¦ APK Details:"
          echo "   Location: $APK_PATH"
          echo "   Size: $(du -h $APK_PATH | cut -f1)"
          echo ""
          
          # Verify APK signature
          echo "ğŸ” Verifying APK signature..."
          if command -v apksigner >/dev/null 2>&1; then
            apksigner verify "$APK_PATH" && echo "âœ… APK signature valid" || echo "âš ï¸ Could not verify signature"
          else
            echo "âš ï¸ apksigner not available, skipping signature verification"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¦ Rename APK with version
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          VERSION=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          NEW_NAME="android/app/build/outputs/apk/release/Xpense-v${VERSION}-${COMMIT_SHORT}.apk"
          
          cp "$APK_PATH" "$NEW_NAME"
          echo "ğŸ“¦ Created: Xpense-v${VERSION}-${COMMIT_SHORT}.apk"

      - name: ğŸ“¤ Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: xpense-apk-${{ github.sha }}
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30
          compression-level: 6

      - name: ğŸ“¤ Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: |
            android/app/build/reports/
            android/app/build/outputs/logs/
          retention-days: 7

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š BUILD SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Build summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ BUILD SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“± App: Xpense"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "ğŸ“¦ Artifact: xpense-apk-${{ github.sha }}"
          echo "ğŸ“¥ Download from the Actions artifacts section"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âŒ Build failed summary
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ BUILD FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please check the logs above for details"
          echo "Build logs have been uploaded to artifacts"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

name: ğŸš€ Build Xpense Android

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  build:
    name: ğŸ“¦ Build Android Release APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT & SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¦ INSTALL DEPENDENCIES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci --prefer-offline --no-audit --loglevel=error
          echo "âœ… Dependencies installed successfully"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ—ï¸ BUILD WEB ASSETS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ—ï¸ Build web assets
        run: |
          echo "ğŸ—ï¸ Building production assets with Vite..."
          npm run build
          echo ""
          echo "ğŸ“Š Build Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total size: $(du -sh dist | cut -f1)"
          echo "Total files: $(find dist -type f | wc -l)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Build completed successfully"
        env:
          NODE_ENV: production

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“± SETUP CAPACITOR ANDROID
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“± Setup Android platform
        run: |
          echo "ğŸ“± Setting up Capacitor Android platform..."
          
          if [ -d "android" ]; then
            echo "ğŸ—‘ï¸ Cleaning existing Android platform..."
            rm -rf android
          fi
          
          echo "â• Adding Android platform..."
          npx cap add android
          echo "âœ… Android platform added"

      - name: ğŸ¨ Generate app icons
        run: |
          echo "ğŸ¨ Generating app icons and splash screens..."
          npx capacitor-assets generate --android || echo "âš ï¸ Icon generation skipped (optional)"
          echo "âœ… Assets generation complete"

      - name: ğŸ”„ Sync Capacitor
        run: |
          echo "ğŸ”„ Syncing web assets to Android..."
          npx cap sync android
          echo "âœ… Capacitor sync completed"

      - name: ğŸ§¹ Remove duplicate uncompressed assets
        run: |
          echo "ğŸ§¹ Removing uncompressed files (keeping .gz versions only)..."
          find android/app/src/main/assets/public/ -type f -name "*.gz" | while read gz_file; do
            original_file="${gz_file%.gz}"
            if [ -f "$original_file" ]; then
              rm -v "$original_file"
            fi
          done
          echo "âœ… Cleaned up uncompressed duplicates"

      - name: ğŸ” Configure Android permissions
        run: |
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          
          echo "ğŸ” Adding Android permissions to manifest..."
          
          if ! grep -q "READ_MEDIA_IMAGES" "$MANIFEST_PATH"; then
            sed -i '/<\/manifest>/i \    <!-- Camera \& Storage Permissions -->\n    <uses-permission android:name="android.permission.CAMERA" \/>\n    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" \/>\n    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" \/>\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" \/>' "$MANIFEST_PATH"
            echo "âœ… Permissions added successfully"
          else
            echo "âœ… Permissions already exist"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” KEYSTORE SETUP (SECURE)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ” Check secrets availability
        id: check-secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "has_keystore=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Keystore secret not found"
          else
            echo "has_keystore=true" >> $GITHUB_OUTPUT
            echo "âœ… Keystore secret available"
          fi

      - name: ğŸ” Setup signing keystore
        if: steps.check-secrets.outputs.has_keystore == 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          KEYSTORE_PATH="android/app/release.keystore"
          
          echo "ğŸ” Setting up release keystore..."
          
          # Decode and save keystore
          echo "$KEYSTORE_BASE64" | base64 -d > "$KEYSTORE_PATH"
          
          if [ ! -f "$KEYSTORE_PATH" ]; then
            echo "âŒ Failed to decode keystore"
            exit 1
          fi
          
          echo "âœ… Keystore configured successfully"
          ls -lh "$KEYSTORE_PATH"

      - name: âŒ Missing keystore error
        if: steps.check-secrets.outputs.has_keystore == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ERROR: Required secrets are missing!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Please add the following secrets to your GitHub repository:"
          echo "   Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
          echo ""
          echo "Required secrets:"
          echo "   â€¢ KEYSTORE_BASE64    - Your keystore file encoded in base64"
          echo "   â€¢ KEYSTORE_PASSWORD  - Your keystore password"
          echo "   â€¢ KEY_ALIAS          - Your key alias (e.g., 'xpense')"
          echo "   â€¢ KEY_PASSWORD       - Your key password"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ How to generate and encode keystore:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "1. Generate keystore:"
          echo "   keytool -genkey -v -keystore release.keystore \\"
          echo "           -alias xpense -keyalg RSA -keysize 4096 \\"
          echo "           -validity 10000"
          echo ""
          echo "2. Encode to base64:"
          echo "   base64 release.keystore | tr -d '\n'"
          echo ""
          echo "3. Copy the output and add as KEYSTORE_BASE64 secret"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

      - name: ğŸ“ Add signing configuration to build.gradle
        if: steps.check-secrets.outputs.has_keystore == 'true'
        run: |
          BUILD_GRADLE="android/app/build.gradle"
          
          echo "ğŸ“ Adding signing configuration to build.gradle..."
          
          # Check if signing config already exists
          if grep -q "signingConfigs {" "$BUILD_GRADLE"; then
            echo "âœ… Signing configuration already exists"
          else
            echo "â• Adding signing configuration..."
            
            # Add signing config after the android { line
            sed -i '/^android {/a\
            \    signingConfigs {\
            \        release {\
            \            if (System.getenv("KEYSTORE_PASSWORD")) {\
            \                storeFile file('\''release.keystore'\'')\
            \                storePassword System.getenv("KEYSTORE_PASSWORD")\
            \                keyAlias System.getenv("KEY_ALIAS")\
            \                keyPassword System.getenv("KEY_PASSWORD")\
            \            }\
            \        }\
            \    }' "$BUILD_GRADLE"
            
            # Update the release buildType to use signing config
            sed -i '/buildTypes {/,/release {/{
              /release {/a\
            \            if (System.getenv("KEYSTORE_PASSWORD")) {\
            \                signingConfig signingConfigs.release\
            \            }
            }' "$BUILD_GRADLE"
            
            echo "âœ… Signing configuration added successfully"
          fi
          
          echo ""
          echo "ğŸ“„ Verifying build.gradle signing config:"
          grep -A 10 "signingConfigs {" "$BUILD_GRADLE" || echo "âš ï¸ Could not display signing config"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ—ï¸ BUILD RELEASE APK
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ”§ Setup Gradle
        if: steps.check-secrets.outputs.has_keystore == 'true'
        run: |
          echo "ğŸ”§ Configuring Gradle wrapper..."
          chmod +x android/gradlew
          echo "âœ… Gradle ready"

      - name: ğŸ—ï¸ Build signed release APK
        if: steps.check-secrets.outputs.has_keystore == 'true'
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "ğŸ—ï¸ Building signed release APK..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            -Porg.gradle.parallel=true \
            -Porg.gradle.caching=true
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… APK build completed successfully"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… VERIFY & PACKAGE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: âœ… Verify APK signature
        if: steps.check-secrets.outputs.has_keystore == 'true'
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          
          echo "âœ… Verifying APK..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at: $APK_PATH"
            echo ""
            echo "ğŸ” Searching for APK files..."
            find android/app/build/outputs -name "*.apk" -type f || true
            exit 1
          fi
          
          echo "âœ… APK found successfully!"
          echo ""
          echo "ğŸ“¦ APK Details:"
          echo "   Location: $APK_PATH"
          echo "   Size: $(du -h $APK_PATH | cut -f1)"
          echo ""
          
          # Verify APK signature with jarsigner
          echo "ğŸ” Verifying APK signature..."
          if jarsigner -verify -verbose -certs "$APK_PATH" 2>&1 | grep -q "jar verified"; then
            echo "âœ… APK is properly signed!"
            echo ""
            echo "ğŸ“ Signature details:"
            jarsigner -verify -verbose -certs "$APK_PATH" 2>&1 | grep -A 5 "Signer"
          else
            echo "âš ï¸ WARNING: APK may not be signed properly!"
            jarsigner -verify -verbose "$APK_PATH" || true
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¦ Rename APK with version
        if: steps.check-secrets.outputs.has_keystore == 'true'
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          VERSION=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          NEW_NAME="android/app/build/outputs/apk/release/Xpense-v${VERSION}-${COMMIT_SHORT}.apk"
          
          cp "$APK_PATH" "$NEW_NAME"
          echo "ğŸ“¦ Created: Xpense-v${VERSION}-${COMMIT_SHORT}.apk"

      - name: ğŸ“¤ Upload release APK
        if: steps.check-secrets.outputs.has_keystore == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: xpense-apk-${{ github.sha }}
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30
          compression-level: 6

      - name: ğŸ“¤ Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: |
            android/app/build/reports/
            android/app/build/outputs/logs/
          retention-days: 7

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š BUILD SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“Š Build summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ BUILD SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“± App: Xpense"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "ğŸ“¦ Artifact: xpense-apk-${{ github.sha }}"
          echo "ğŸ“¥ Download from the Actions artifacts section"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âŒ Build failed summary
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ BUILD FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please check the logs above for details"
          echo "Build logs have been uploaded to artifacts"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"